(self.webpackChunk=self.webpackChunk||[]).push([[1790],{51790:(t,e,r)=>{r.r(e),r.d(e,{HWRListenerImpl:()=>j});var n,s,a,o,i=r(34453),l=r(5604),c=r(82562),h=r(78615),d=r(24121),u=r(44127),g=r(64524),p=r(5314),m=r(50683),_=r(45327),S=r(77141),y=r(562),C=r(32559);!function(t){let e;!function(t){t.create=function(t){return{timestamp:t.timestamp,delta:t.delta,copyContentId:t.sourceContentId}},t.parse=function(t){try{const e=t;return e.timestamp&&!isNaN(e.timestamp)&&e.delta?{timestamp:Number(e.timestamp),delta:e.delta,sourceContentId:e.copyContentId?String(e.copyContentId):void 0}:null}catch(t){return null}}}(e=t.Legacy||(t.Legacy={})),t.is=function(t){return null!==t}}(n||(n={})),function(t){let e;!function(t){t.create=function(t){return{timestamp:t.timestamp,text:t.char,copiedContentId:void 0!==t.sourceContentId&&null!==t.sourceContentId&&""!==t.sourceContentId?t.sourceContentId:void 0,isSelfAuthored:t.isSelfAuthored}},t.parse=function(t){try{const e=t;return void 0!==e.text&&e.text.length&&e.timestamp&&void 0!==e.isSelfAuthored?{char:String(e.text),timestamp:Number(e.timestamp),sourceContentId:e.copiedContentId?String(e.copiedContentId):void 0,isSelfAuthored:Boolean(e.isSelfAuthored)}:null}catch(t){return null}}}(e=t.Legacy||(t.Legacy={})),t.is=function(t){return null!==t}}(s||(s={})),function(t){let e;t.create=function(t,e,r,n,s){let a=[],o=[],i=[];return n&&((0,C.kG)(r.length==n.length,`Expected that the text length ${r.length} be the same as the Char[] length ${n.length}`),a=n.map((t=>t.timestamp)),o=n.map((t=>t.isSelfAuthored)),i=n.map((t=>t.sourceContentId||null))),{id:crypto.randomUUID(),url:t,sourceName:e,text:r,timestamps:a,isSelfAuthoredTags:o,originalSourceContentIds:i,prompt:s}},function(t){t.create=function(t){return{id:t.id,url:t.url,sourceName:t.sourceName,text:t.text,timestamps:t.timestamps,isSelfAuthoredTags:t.isSelfAuthoredTags,originalCopiedContentIds:t.originalSourceContentIds,prompt:t.prompt||null}},t.parse=function(t){try{const e=t;if(e.id&&e.url&&e.sourceName&&e.text&&Array.isArray(e.timestamps)&&Array.isArray(e.isSelfAuthoredTags)&&Array.isArray(e.originalCopiedContentIds)){const t=e.timestamps.filter((t=>!isNaN(t))),r=e.isSelfAuthoredTags.map(Boolean),n=e.originalCopiedContentIds.filter((t=>null===t||"string"==typeof t));return t.length===r.length&&r.length===n.length?{id:e.id,url:e.url,sourceName:e.sourceName,text:e.text,timestamps:t,isSelfAuthoredTags:r,originalSourceContentIds:n,prompt:e.prompt||void 0}:null}return null}catch(t){return null}}}(e=t.Legacy||(t.Legacy={})),t.is=function(t){return null!==t}}(a||(a={})),function(t){let e,r;t.empty=function(t){return{id:t,chars:[],sourcedContentStore:{kind:"internal",data:[]},deltaEdits:[]}},function(t){t.create=function(t){return{id:t.id,chararray:t.chars.map(s.Legacy.create),copyStore:{storeType:t.sourcedContentStore.kind,data:t.sourcedContentStore.data.map(a.Legacy.create)},deltas:t.deltaEdits.map(n.Legacy.create)}},t.parse=function(t){try{const e=t;if(e.id&&Array.isArray(e.chararray)&&e.copyStore&&e.copyStore.storeType&&Array.isArray(e.copyStore.data)&&Array.isArray(e.deltas)){const t=e.chararray.map(s.Legacy.parse).filter(s.is),r=e.copyStore.data.map(a.Legacy.parse).filter(a.is),o=e.deltas.map(n.Legacy.parse).filter(n.is);return t.length!==e.chararray.length||r.length!==e.copyStore.data.length||o.length!==e.deltas.length?null:{id:e.id,chars:t,sourcedContentStore:{kind:e.copyStore.storeType,data:r},deltaEdits:o}}return null}catch(t){return null}}}(e=t.Legacy||(t.Legacy={})),function(t){t.create=function(t,e,r,o){return{chararray:t.chars.map(s.Legacy.create),copy_store:{storeType:t.sourcedContentStore.kind,data:t.sourcedContentStore.data.map(a.Legacy.create)},deltas:t.deltaEdits.map(n.Legacy.create),document_title:r,document_url:o,last_updated_at:e}}}(r=t.Backend||(t.Backend={}))}(o||(o={}));var f,x=r(22115),b=r(34822),I=r(67167),T=r(46210),v=r(54109),w=r(58376),A=r(39144);class k{constructor(){this._rpc=(0,A.OB)().bgRpc,this._log=S.Y.create("GoogleDocsSourcedContentStore")}async getMatch(t,e,r){let n=null;return x.QY.getNumInsertedLetters(e)>=y.Uv&&x.QY.getNumDeletedLetters(e)>0&&(t.endsWith(" ")||t.endsWith("\n"))?n=a.create("hwr://delta/rewrite/google/correct/","Google Docs Corrections",t):0==x.QY.getNumDeletedLetters(e)&&x.QY.getNumInsertedLetters(e)>=y.Uv&&x.QY.getNumInsertedLetters(e)<=y.QU&&(n=await this._matchPhraseCompletion(t,r)),this._log.debug(`[GoogleDocsSuggestionStore] getMatch('${t}') returning:`,n),n}async _matchPhraseCompletion(t,e){let r=null,n=null;if(null!=this._rpc.api.autocompletePhrase&&(n=await this._rpc.api.autocompletePhrase(e)),null!=n){const e=n.text.substring(n.prefixBegin-n.textBegin,n.prefixEnd-n.textBegin),s=n.text.substring(n.prefixEnd-n.textBegin),o=n.text.substring(e.length);(s==t||s.startsWith(t)||t.startsWith(s))&&(this._log.debug(`[GoogleDocsSuggestionStore] match: ${t} response: ${o}`),r=a.create("hwr://delta/rewrite/google/completion/","Google Docs Smart Compose Suggestions",t))}return r}}!function(t){t.Internal="internal",t.Selection="selection",t.GrammarlyPrevious="grammarly-previous",t.GrammarlyCurrent="grammarly-current",t.External="external",t.GDocs="gdocs",t.Startup="startup",t.Temporary="temporary",t.Test="test"}(f||(f={}));class D{constructor(t,e=[],r=1/0){this.kind=t,this.data=e,this._maxRecordsCount=r,this._sourcedContentById=new Map,this.data.forEach((t=>{this._sourcedContentById.set(t.id,t)})),this._log=S.Y.create(`[${this.kind}] ${D.name}`),this._keepLastN()}getMatch(t,e){var r;let n=this.data;e&&(n=this.data.filter(e));const s=n.find((({text:e})=>e===t))||null;return null===(r=this._log)||void 0===r||r.info(`[${this.kind}] getMatch('${(0,x.aS)(t,40)}') returning:`,s),s}getFuzzyMatch(t,e){var r;const n=(1-e)*t.length,s=this.data.find((e=>{var r,s;const a=(0,x.CZ)(e.text),o=v.zI.diffAsChanges(a,t);return null===(r=this._log)||void 0===r||r.info(`[FuzzyMatch] text length: ${t.length}, amount changed: ${o.amount}`),null===(s=this._log)||void 0===s||s.info("Delta",o),o.amount<=n&&!x.Hq.hasPerLetterTags(e)}))||null;return null===(r=this._log)||void 0===r||r.info(`[${this.kind}] getFuzzyMatch('${(0,x.aS)(t,40)}') returning:`,s),s}getContentById(t){return this._sourcedContentById.get(t)||null}addContent(t){var e;null===(e=this._log)||void 0===e||e.info("addContent",t),this.data.push(t),this._sourcedContentById.set(t.id,t),this._keepLastN()}_keepLastN(){this.data.length<=this._maxRecordsCount||(this.data.slice(0,this.data.length-this._maxRecordsCount).forEach((({id:t})=>{this._sourcedContentById.delete(t)})),this.data=this.data.slice(-this._maxRecordsCount))}}class L{constructor(t,e,r,n){this.text=t,this.delta=e,this.timestamp=r,this.sourcedContent=n,null!=n&&n.timestamps.length>0&&((0,C.kG)(t.length==n.timestamps.length),(0,C.kG)(t.length==n.isSelfAuthoredTags.length),(0,C.kG)(t.length==n.originalSourceContentIds.length))}getCharAt(t){var e,r,n;const s=null!=this.sourcedContent?this.sourcedContent.timestamps:[],a=(null===(e=this.sourcedContent)||void 0===e?void 0:e.isSelfAuthoredTags)||[],o=(null===(r=this.sourcedContent)||void 0===r?void 0:r.originalSourceContentIds)||[];let i=this.timestamp,l=x.QY.getNumInsertedLetters(this.delta)<=y.OX,c=(null===(n=this.sourcedContent)||void 0===n?void 0:n.id)||null;return s.length>0&&(i=s[t],l=l||a[t],c=o[t]||c),{char:this.text[t],timestamp:i,sourceContentId:c||void 0,isSelfAuthored:l}}}var R=r(13058),E=r(25394);class G{constructor(t){this._documentId=t,this._chars=[],this._last_updated_at=Date.now(),this._log=S.Y.create("ChangeTrackerImpl"),this._deltaEdits=[],this._internalCopyStore=new D(f.Internal,[]),this._internalSelectionStore=new D(f.Selection),this._prevGrammarlyAlerts=new D(f.GrammarlyPrevious),this._currentGrammarlyAlerts=new D(f.GrammarlyCurrent),this._externalCopyStore=new D(f.External,[],4),this._googleDocsSourcedContentStore=new k,this.startupCopyStore=new D(f.Startup,[],4)}startTracking(t,e){this._chars=t.chars,this._internalCopyStore=new D(f.Internal,t.sourcedContentStore.data),this._deltaEdits=t.deltaEdits;const r=v.zI.diffAsChanges(t.chars.map((t=>t.char)).join(""),e);return r.delta.forEach((t=>{w.s.isInsertString(t)&&this.startupCopyStore.addContent(a.create("hwr://delta/startup/","Delta on Document load",t.insert))})),this.onTextChange(r.delta)}async onTextChange(t){if(this._log.info("Got text change",t),0===t.ops.length)return void this._log.info("Noop change, skipping");const e=w.s.normalizeDelta(w.s.cleanAllAttrs(t));this._log.info("Squashed delta",e),this._log.info("Text insert",`|${x.QY.extractMaximalReplacementString(this._chars.map((t=>t.char)).join(""),e)||"null"}|`);const r=Date.now(),n={timestamp:r,delta:e,sourceContentId:await this._applyDelta(e,r)||void 0};this._deltaEdits.push(n),this._last_updated_at=Date.now()}onSelectionChange(t){t.forEach((t=>{if(t.start!=t.end&&t.end-t.start>1){const e=this._chars.slice(t.start,t.end).map((t=>t.char)).join(""),r=this._chars.slice(t.start,t.end);this._internalSelectionStore.addContent(a.create(self.location.href,self.name||"Unnamed",e,r)),this._log.debug("HWR Selected Text:",{selectedText:e,selection_info:r})}}))}onAlertChange(t){this._log.debug("onAlertChange",t);const e=new D(f.Temporary);for(const[r,n]of Object.entries(t)){if(void 0===n||!I.S.isCapiAlert(n))continue;const t=n.text;n.replacements.forEach((n=>{const s=x.QY.extractMaximalReplacementString(t,v.zI.diffAsChanges(t,n).delta);s&&s.length>=y.Uv&&e.addContent(a.create("hwr://delta/rewrite/grammarly/correct/?id="+r,"Grammarly edited: ("+t+" -> "+n+")",s))}))}x.Hq.eq(e.data,this._currentGrammarlyAlerts.data)||(this._prevGrammarlyAlerts=new D(f.GrammarlyPrevious,this._currentGrammarlyAlerts.data),this._currentGrammarlyAlerts=new D(f.GrammarlyCurrent,e.data))}addCopiedTextToExternalStore(t){if(!t.valid)return;const e=t.copiedText||"";null==this._externalCopyStore.getMatch(e)&&this._externalCopyStore.addContent(a.create(t.sourceURL||"",t.sourceName||"",e,void 0,t.userPrompt))}onReplacementApplied(t,e){if(this._log.debug("HWR replacement applied",{source:t,replacement:e}),t===T.P.snippets||t===T.P.oggyGenAI){let r="";void 0!==e.pos&&(r=this._chars.slice(e.pos.start,e.pos.end).map((t=>t.char)).join(""));const n=x.QY.extractMaximalReplacementString(r,"string"==typeof e.value?v.zI.diffAsChanges(r,e.value).delta:e.value);n&&n.length>=y.Uv&&this._internalCopyStore.addContent(a.create("hwr://delta/rewrite/grammarly/"+t,"Grammarly generated ("+t+")",n))}}getDocumentState(){return{id:this._documentId,chars:this._chars,sourcedContentStore:{kind:"internal",data:this._internalCopyStore.data},deltaEdits:this._deltaEdits}}getReportableDocument(){return o.Backend.create(this.getDocumentState(),this._last_updated_at,document.title,self.location.href)}getTextInfoForAlert(t){const e=[];return(0,b.C)(t).forEach((t=>{if("transform"==t.meta.rangePurpose)for(let r=t.start;r<t.end;++r)e.push({...this._chars[r]})})),e}_applySingleDeletion(t,e){this._chars.splice(t,e)}_applySingleInsertion(t,e){const r=e.text.length,n=Array.from({length:r},((t,r)=>e.getCharAt(r)));this._chars.splice(t,0,...n)}async _searchAllCopyStores(t,e,r){let n=this._internalCopyStore.getMatch(t,(t=>"hwr://delta/startup/"!=t.url));return n?{storeKind:this._internalCopyStore.kind,sourcedContent:n}:(n=this._internalSelectionStore.getMatch(t),n?{storeKind:f.Selection,sourcedContent:n}:(n=this._prevGrammarlyAlerts.getMatch(t),n?{storeKind:f.GrammarlyPrevious,sourcedContent:n}:(n=this._externalCopyStore.getMatch(t),n?{storeKind:f.External,sourcedContent:n}:(n=await this._googleDocsSourcedContentStore.getMatch(t,e,r),n?{storeKind:f.GDocs,sourcedContent:n}:(n=this.startupCopyStore.getMatch(t),n?{storeKind:f.Startup,sourcedContent:n}:(n=this._externalCopyStore.getFuzzyMatch(t,.95),n?{storeKind:f.External,sourcedContent:n}:null))))))}async _applyDelta(t,e){let r=null,n=0;const s=this._chars.map((t=>t.char)).join(""),a=x.QY.extractMaximalReplacementString(s,t),o=(0,R.zG)(w.s.rangeOfTheChange(t),E.UI((([t])=>s.substring(0,t))),E.fS((()=>s))),i=a?await this._searchAllCopyStores(a,t,o):null;r=(null==i?void 0:i.sourcedContent.id)||null,i&&i.storeKind!=f.Internal&&this._internalCopyStore.addContent(i.sourcedContent),this._log.info("Content search result",i);for(const r of t.ops)w.s.isRetain(r)?n+=r.retain:w.s.isInsertString(r)?(this._applySingleInsertion(n,new L(r.insert,t,e,(null==i?void 0:i.sourcedContent)||null)),n+=r.insert.length):w.s.isDelete(r)&&(this._trackDeletion(n,r.delete),this._applySingleDeletion(n,r.delete));return r}_trackDeletion(t,e){const r=Array.from({length:e},((e,r)=>this._chars[t+r])),n=r.map((t=>t.char)).join("");this._onCopyDelete(n,r)}_onCopyDelete(t,e){t.length>=y.Uv&&this._internalCopyStore.addContent(a.create(self.location.href,self.name||"Unnamed",t,e))}onCopy(t){t.forEach((t=>{if(t.start!=t.end){const e=this._chars.slice(t.start,t.end).map((t=>t.char)).join(""),r=this._chars.slice(t.start,t.end);this._onCopyDelete(e,r)}}))}_getCSSFormatForLetter(t){const e="color: red;",r="color: black;",n=t.sourceContentId,s=null!=n?this._internalCopyStore.getContentById(n):null;let a;return a=null!=s?s.url.match(/delta\/rewrite\/grammarly\/(oggyGenAI|snippets)/)?"color: blue;":s.url.match("delta/rewrite/grammarly/correct")?"color: green;":s.url.match(/(chat.openai.com|chatgpt.com)/)?"color: purple;":s.url.match("gemini.google.com")?"color: orange;":s.url.match("delta/rewrite/google")?"color: teal;":s.url.match("delta/startup")?e:t.isSelfAuthored?r:e:t.isSelfAuthored?r:e,a}_logText(){const t=this._chars.map((t=>`%c${t.char}`)).join(""),e=this._chars.map((t=>this._getCSSFormatForLetter(t)));self.console.log(`HWR: ${t}`,...e)}}const M="document_state";class N{constructor(t,e,r,n){this.uniqId=t,this.onReadSuccess=e,this.onReadError=r,this.onWriteResult=n,this._log=S.Y.create("HWRStorage"),this.reload()}reload(){const t=indexedDB.open("human_writing_report",1);this._request=t,t.onsuccess=e=>{this._db=t.result,this._log.info("openDb DONE");const r=this._db.transaction([M],"readonly").objectStore(M).get(this.uniqId);r.onerror=t=>{this.onReadError()},r.onsuccess=t=>{const e=r.result;if(e){const t=o.Legacy.parse(e);t?this.onReadSuccess(t):this.onReadError()}else this.onReadError()}},t.onerror=e=>{this._log.error("openDb:",t.error)},t.onupgradeneeded=t=>{this._log.info("openDb.onupgradeneeded");const e=t.target.result;[M].forEach((t=>{e.createObjectStore(t,{keyPath:"id",autoIncrement:!1})}))}}writeDocumentState(t){const e=this._db.transaction([M],"readwrite").objectStore(M).put(o.Legacy.create(t));e.onerror=t=>{this.onWriteResult("error")},e.onsuccess=t=>{this.onWriteResult("success")}}}class j{constructor(t,e,r,n,s,a,u=(()=>document.hidden)){this._listenerId=t,this._alertsState=e,this._textObserver=r,this._selectionSource=n,this._CSState=s,this._replacementListener=a,this._getDocumentHidden=u,this._subs=new l.L,this._ready=!1,this._log=S.Y.create("HWRListenerImpl"),this._documentVisibilityObs=(0,c.R)(document,"visibilitychange").pipe((0,d.B)()),this._documentStateSubj=new h.xQ,this._writeToStorageRequestSubj=new h.xQ,this._log.info("Document id",t);const g=new i.m;this._documentId=g.documentID||this._listenerId,this._changeTracker=new G(this._documentId),this._hwrStorage=new N(this._documentId,(t=>{this._documentStateSubj.next(t)}),(()=>{this._documentStateSubj.next(o.empty(this._documentId))}),(t=>{this._log.info(`[On Write] Status: ${t}`)})),this._log.info("HWR Storage",this._hwrStorage),this._changeTracker.addCopiedTextToExternalStore(this._CSState.view("copiedTextMessage").get()),this._setupEventHandlers()}get changeTracker(){return this._changeTracker}get documentId(){return this._documentId}_setupEventHandlers(){this._subs.add(this._replacementListener.obs.subscribe((t=>{this._changeTracker.onReplacementApplied(t.source,t.replacement)}))),this._subs.add(this._alertsState.pipe((0,u.h)((()=>this._ready))).subscribe(this._changeTracker.onAlertChange.bind(this._changeTracker))),this._subs.add(this._textObserver.contentChanges.async.pipe((0,u.h)((()=>this._ready))).subscribe(this._handleTextChange.bind(this))),this._subs.add(this._selectionSource.data.changes.subscribe(this._changeTracker.onSelectionChange.bind(this._changeTracker))),this._subs.add(this._writeToStorageRequestSubj.pipe((0,g.b)(1e3)).subscribe((()=>this._writeToStorage()))),this._documentVisibilityObs.pipe((0,p.U)(this._getDocumentHidden)).subscribe((t=>{t?this._stopTracking():this._hwrStorage.reload()})),this._subs.add(this._documentStateSubj.pipe((0,m.M)(this._documentVisibilityObs.pipe((0,p.U)(this._getDocumentHidden),(0,_.O)(this._getDocumentHidden())))).subscribe((([t,e])=>{e||this._handleDocumentStateChange(t)})))}_stopTracking(){this._log.info("Stopping document tracking"),this._ready=!1}async _handleDocumentStateChange(t){this._log.info("Get saved or Empty document. Starting tracking",t),await this._changeTracker.startTracking(t,this._textObserver.getCurrentTextMap().getPlainText()),this._ready=!0,this._writeToStorage()}_writeToStorage(){this._hwrStorage.writeDocumentState(this._changeTracker.getDocumentState())}_handleTextChange(t){this._log.info("HWR text data: ",t);const e=this._CSState.view("copiedTextMessage").get();this._log.info("Most Recent Copied Text: ",e),this._changeTracker.addCopiedTextToExternalStore(e);const r=t.deltaChange.delta;this._log.info("HWR single delta: ",r),r.ops.length>0&&this._changeTracker.onTextChange(r).then((()=>{this._writeToStorageRequestSubj.next()}))}dispose(){this._subs.unsubscribe(),this._writeToStorage()}}}}]);